name: Release

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel in-progress releases

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  NODE_VERSION: '20'
  PNPM_VERSION: 9

jobs:
  package:
    name: Package VSIX
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: release-${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            release-${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Download LSP binaries from the latest LSP release
      - name: Download LSP binaries
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create bin directory for server binaries
          mkdir -p bin/linux-x64 bin/linux-arm64 bin/windows-x64 bin/darwin-x64 bin/darwin-arm64
          
          # Get the latest LSP release tag
          LATEST_TAG=$(gh release view --repo GodSpeedAI/domainforge-lsp --json tagName --jq '.tagName')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "::error::No LSP release found"
            exit 1
          fi
          
          echo "Downloading LSP binaries from latest release: ${LATEST_TAG}"
          
          # Download all platform binaries
          # Linux x64
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-linux-x64" --output "bin/linux-x64/domainforge-lsp" || echo "::warning::Linux x64 LSP not found"
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-linux-x64-mcp" --output "bin/linux-x64/domainforge-mcp" || echo "::warning::Linux x64 MCP not found"
          chmod +x bin/linux-x64/domainforge-lsp bin/linux-x64/domainforge-mcp || true

          # Linux ARM64
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-linux-arm64" --output "bin/linux-arm64/domainforge-lsp" || echo "::warning::Linux ARM64 LSP not found"
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-linux-arm64-mcp" --output "bin/linux-arm64/domainforge-mcp" || echo "::warning::Linux ARM64 MCP not found"
          chmod +x bin/linux-arm64/domainforge-lsp bin/linux-arm64/domainforge-mcp || true

          # Windows x64
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-windows-x64.exe" --output "bin/windows-x64/domainforge-lsp.exe" || echo "::warning::Windows LSP not found"
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-windows-x64-mcp.exe" --output "bin/windows-x64/domainforge-mcp.exe" || echo "::warning::Windows MCP not found"

          # macOS x64
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-darwin-x64" --output "bin/darwin-x64/domainforge-lsp" || echo "::warning::macOS x64 LSP not found"
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-darwin-x64-mcp" --output "bin/darwin-x64/domainforge-mcp" || echo "::warning::macOS x64 MCP not found"
          chmod +x bin/darwin-x64/domainforge-lsp bin/darwin-x64/domainforge-mcp || true

          # macOS ARM64
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-darwin-arm64" --output "bin/darwin-arm64/domainforge-lsp" || echo "::warning::macOS ARM LSP not found"
          gh release download "${LATEST_TAG}" --repo GodSpeedAI/domainforge-lsp --pattern "domainforge-lsp-darwin-arm64-mcp" --output "bin/darwin-arm64/domainforge-mcp" || echo "::warning::macOS ARM MCP not found"
          chmod +x bin/darwin-arm64/domainforge-lsp bin/darwin-arm64/domainforge-mcp || true
          
          echo "Downloaded binaries from ${LATEST_TAG}:"
          find bin -type f | head -20

      - name: Package extension
        run: pnpm run package && pnpm dlx @vscode/vsce package --no-dependencies

      - name: Check VSIX size
        run: |
          VSIX=$(ls *.vsix | head -1)
          SIZE=$(stat -c%s "$VSIX")
          echo "VSIX size: $SIZE bytes ($(numfmt --to=iec $SIZE))"
          # Warn if VSIX exceeds 50MB (with binaries)
          if [ "$SIZE" -gt 52428800 ]; then
            echo "::warning::VSIX size ($SIZE bytes) is large"
          fi

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: domainforge-vsix
          path: '*.vsix'
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Download VSIX artifact
        uses: actions/download-artifact@v4
        with:
          name: domainforge-vsix
          path: ./

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: '*.vsix'
          generate_release_notes: true

  publish:
    name: Publish to Marketplaces
    needs: package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only publish if marketplace publishing is enabled
    if: ${{ vars.MARKETPLACE_PUBLISH_ENABLED == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download VSIX
        uses: actions/download-artifact@v4
        with:
          name: domainforge-vsix
          path: ./

      - name: Publish to Open VSX Registry
        uses: HaaLeo/publish-vscode-extension@v2
        id: publishToOpenVSX
        with:
          pat: ${{ secrets.OPEN_VSX_TOKEN }}

      - name: Publish to Visual Studio Marketplace
        uses: HaaLeo/publish-vscode-extension@v2
        with:
          pat: ${{ secrets.VSCE_PAT }}
          registryUrl: https://marketplace.visualstudio.com
          extensionFile: ${{ steps.publishToOpenVSX.outputs.vsixPath }}
